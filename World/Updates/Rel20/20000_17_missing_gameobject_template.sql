-- --------------------------------------------------------------------------------
-- This is an attempt to create a full transactional update
-- --------------------------------------------------------------------------------
DROP PROCEDURE IF EXISTS `update_mangos`; 

DELIMITER $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `update_mangos`()
BEGIN
    DECLARE bRollback BOOL  DEFAULT FALSE ;
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `bRollback` = TRUE;

  SET @cOldRev = 'required_20000_16_npc_trainer_fixes';

  -- Set the new revision string
  SET @cNewRev = 'required_20000_17_missing_gameobject_template';

  -- Set thisRevision to the column name of db_version in the currently selected database
  SET @cThisRev := ((SELECT column_name FROM information_schema.`COLUMNS` WHERE table_name='db_version' AND table_schema=(SELECT DATABASE() AS thisDB FROM DUAL) AND column_name LIKE 'required%'));

 
  -- Only Proceed if the old values match
  IF @cThisRev = @cOldRev THEN
    -- Make this all a single transaction
    START TRANSACTION;

    -- Apply the Version Change from Old Version to New Version
    SET @query = CONCAT('ALTER TABLE db_version CHANGE COLUMN ',@cOldRev, ' ' ,@cNewRev,' bit;');
    PREPARE stmt1 FROM @query;
    EXECUTE stmt1;
    DEALLOCATE PREPARE stmt1;
    -- The Above block is required for making table changes

    -- -- -- -- Normal Update / Insert / Delete statements will go here  -- -- -- -- --
    
DELETE FROM GAMEOBJECT_TEMPLATE WHERE ENTRY IN (103575,128972,129,160842,175590,176592,176750,177493,177529,178124,178188,178248,178644,178673,178963,179527,179530,179531,180525,181214,181290,181604,181831,181838,181840,181842,181844,183929,184718,184910,184958,184981,185297,185305,185862,186471,188509,190721,194645,195089,195641,4);

INSERT INTO GAMEOBJECT_TEMPLATE
(`entry`, `type`, `displayId`, `name`, `IconName`, `castBarCaption`, `unk1`, `faction`, `flags`, `size`, `questItem1`, `questItem2`, `questItem3`, `questItem4`, `questItem5`, `questItem6`, `data0`, `data1`, `data2`, `data3`, `data4`, `data5`, `data6`, `data7`, `data8`, `data9`, `data10`, `data11`, `data12`, `data13`, `data14`, `data15`, `data16`, `data17`, `data18`, `data19`, `data20`, `data21`, `data22`, `data23`, `mingold`, `maxgold`, `ScriptName`)
VALUES
('103575', '6', '327', 'Containment Coffer TRAP', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '9012', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('128972', '6', '299', 'TEMP Shallow Grave Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '10247', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('160842', '6', '2770', 'Gor\'tesh\'s Lopped Off Head', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '50', '13488', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('175590', '6', '299', 'TEMP Spire Spider Egg Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '16453', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('176592', '6', '299', 'TEMP Shellfish Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '17679', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('176750', '6', '299', 'Kodo Bones Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '17960', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('177493', '6', '327', 'Fire of Elune (Trap)', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '18955', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('177529', '6', '327', 'Altar of Elune (Trap) (DND)', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '18993', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('178124', '6', '327', 'Resonite Crystal (Trap)', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '5', '20492', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('178188', '6', '410', 'Molten Core Circle BARON', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('178248', '6', '327', 'Naga Brazier (trap) (DND)', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '20863', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('178644', '6', '299', 'TEMP Ryson\'s All Seeing Eye Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '21546', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('178673', '6', '5752', 'Consuming Flames Trap', '', '', '', '0', '0', '1.2', '0', '0', '0', '0', '0', '0', '95', '60', '20', '21650', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('178963', '6', '2770', 'Incantion of Celebras Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '21917', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('179527', '6', '299', 'TEMP Warpwood Pod Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '22800', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('179530', '6', '299', 'TEMP Warpwood Pod Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '22800', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('179531', '6', '299', 'TEMP Warpwood Pod Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '22800', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('180525', '6', '6424', 'Tonk Control Console Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '24935', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181214', '6', '327', 'Necropolis critter spawner', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '27866', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181290', '6', '0', 'Midsummer Bonfire Spawn Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '28784', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181604', '6', '6771', 'TEST Ribbon Pole TRAP', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '29708', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181831', '6', '299', 'TEMP Sealed Tome Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '30762', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181838', '6', '299', 'TEMP Sealed Tome Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '30763', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181840', '6', '299', 'TEMP Sealed Tome Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '30764', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181842', '6', '299', 'TEMP Sealed Tome Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '30765', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('181844', '6', '299', 'TEMP Sealed Tome Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '30766', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('183929', '6', '0', '', '', '', '', '35', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('184718', '6', '327', 'Cauldron Summoner', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '36549', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('184910', '6', '2373', 'Power Converter', '', '', '', '0', '0', '0.5', '0', '0', '0', '0', '0', '0', '0', '0', '0', '37278', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('184958', '6', '7247', 'Nether Drake Egg', '', '', '', '0', '0', '1.5', '0', '0', '0', '0', '0', '0', '0', '0', '0', '37574', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('184981', '6', '299', 'TEMP Felhound Poo Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '37695', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('185297', '6', '1310', 'Lianthe\'s Strongbox', '', '', '', '0', '0', '2', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('185305', '6', '7298', 'Fumper Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '39217', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('185862', '6', '0', 'Fel Cannonball Stack Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '40181', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('186471', '6', '6371', 'Super Brew Stein', '', '', '', '35', '0', '3', '0', '0', '0', '0', '0', '0', '0', '0', '8', '42696', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('188509', '6', '2770', 'Dark Iron Mole Machine (Minion Summoner Trap)', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '47375', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('190721', '6', '0', 'Harvested Blight Crystal', '', '', '', '0', '0', '0.5', '0', '0', '0', '0', '0', '0', '0', '0', '0', '52261', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('194645', '6', '5932', 'Stone Block Trap', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '64055', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('195089', '6', '0', 'Spirit Candle', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '10', '65459', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', ''),
('195641', '6', '0', 'Brazier', '', '', '', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '1', '1', '7897', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '');

    -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
    
    -- If we get here ok, commit the changes
    IF bRollback = TRUE THEN
      ROLLBACK;
      SELECT '* UPDATE FAILED *' AS 'Status',@cThisRev AS 'DB is on Version';
    ELSE
      COMMIT;
      SELECT '* UPDATE COMPLETE *' AS 'Status',@cNewRev AS 'DB is now on Version';
    END IF;
  ELSE
    SELECT '* UPDATE SKIPPED *' AS 'Status',@cOldRev AS 'Required Version',@cThisRev AS 'Found Version';
  END IF;

END $$

DELIMITER ;

-- Execute the procedure
CALL update_mangos();

-- Drop the procedure
DROP PROCEDURE IF EXISTS `update_mangos`;
